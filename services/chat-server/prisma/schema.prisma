generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("CHAT_DATABASE_URL")
}

model Conversation {
  id              String   @id @default(cuid())
  status          String   @default("open") // open | assigned | closed
  visitorSessionId String
  visitorIp       String
  visitorUa       String?
  entryUrl        String?
  referrer        String?
  assignedAdminId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  closedAt        DateTime?

  messages         Message[]
  tags             ConversationTag[]
  notes            Note[]
  riskScores       RiskScore[]

  @@index([status, updatedAt])
  @@index([visitorSessionId, status])
  @@index([assignedAdminId, status])
}

model ConversationTag {
  id             String   @id @default(cuid())
  conversationId String
  tag            String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([tag])
}

model Note {
  id             String   @id @default(cuid())
  conversationId String
  adminId        String
  bodyText       String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([adminId, createdAt])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderType     String   // visitor | admin | system
  adminId        String?
  bodyText       String
  ip             String?
  sessionId      String?
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderType, createdAt])
}

model Ticket {
  id             String   @id @default(cuid())
  conversationId String?
  visitorSessionId String?
  visitorIp       String?
  visitorUa       String?
  contact         String?
  bodyText        String
  status          String   @default("open") // open | closed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status, updatedAt])
}

model CannedReply {
  id        String   @id @default(cuid())
  title     String
  bodyText  String
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IpBlock {
  id        String   @id @default(cuid())
  ip        String
  reason    String
  createdBy String?
  expiresAt DateTime?
  createdAt DateTime @default(now())

  @@unique([ip])
  @@index([expiresAt])
}

model RiskScore {
  id             String   @id @default(cuid())
  conversationId String
  score          Int      @default(0)
  reason         String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model Event {
  id             String   @id @default(cuid())
  actorType      String   // visitor | admin | system
  actorId        String?
  action         String   // LOGIN_OK / INVALID_EVENT / THROTTLED / ...
  ip             String?
  sessionId      String?
  conversationId String?
  detailJson     Json?
  createdAt      DateTime @default(now())

  @@index([action, createdAt])
  @@index([conversationId, createdAt])
}

model KbArticle {
  id        String   @id @default(cuid())
  locale    String   @default("zh")
  title     String
  bodyText  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([locale, isActive])
}

model Locale {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson Json
  updatedAt DateTime @updatedAt
}

model Integration {
  id        String   @id @default(cuid())
  type      String   // telegram | whatsapp | email
  configJson Json
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, isActive])
}

// P4 attachments (locked off before P4; table exists but server won't expose endpoints)
model Attachment {
  id             String   @id @default(cuid())
  conversationId String
  messageId      String?
  url            String
  sha256         String?
  mimeType       String?
  sizeBytes      Int?
  createdAt      DateTime @default(now())

  @@index([conversationId, createdAt])
}

