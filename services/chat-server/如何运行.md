# chat-server 怎么跑（一步步说明）

## 第一步：进入 chat-server 文件夹

在项目里找到 **services** 文件夹，点进去，再点进 **chat-server**。

路径示例：`Website-new\services\chat-server`

---

## 第二步：准备 .env 文件

在这个 **chat-server** 文件夹里，要有一个叫 **`.env`** 的配置文件（没有的话就建一个）。

- **如果还没有 .env**：  
  把同文件夹里的 **`.env.example`** 复制一份，把复制出来的文件**改名为** **`.env`**。
- **如果已经有 .env**：  
  直接打开它即可。

---

## 第三步：看你要「本地试看」还是「上生产」

打开 **`.env`** 后，找到这一行：

```env
CHAT_DATABASE_URL="..."
```

- **你只是想在自己电脑上试 Live Chat（本地试看）**  
  把这一行改成（或保持为）：
  ```env
  CHAT_DATABASE_URL="file:./dev.chat.db"
  ```
  这样用的是本地的 SQLite 文件，不用装数据库。

- **你是要部署到正式环境（生产）**  
  把这一行改成你的 Postgres 连接串，例如：
  ```env
  CHAT_DATABASE_URL="postgresql://用户名:密码@服务器:5432/数据库名"
  ```
  并确保服务器上已经建好这个数据库。

其他几项（如 `CHAT_ADMIN_JWT_SECRET`、`CHAT_ALLOWED_ORIGINS`、`ADMIN_ALLOWED_ORIGINS`）按 `.env.example` 里的说明填好即可。

---

## 第四步：在 chat-server 文件夹里执行两条命令

在 **chat-server** 文件夹里打开终端（PowerShell 或 CMD），依次执行：

```bash
npm install
```

等装完后再执行：

```bash
npm run dev
```

看到类似 `SERVER_OK port=4000`、`DB_OK`、`WS_OK` 就说明 chat-server 已经跑起来了。

---

## 小结（对应你问的那一段）

- **「复制并编辑 .env」** = 在 **chat-server** 文件夹里，用 **.env.example** 复制出一份 **.env**，然后打开 **.env** 按上面第三步改好 `CHAT_DATABASE_URL` 等。
- **「在 services/chat-server 下执行」** = 在资源管理器里点进 **services** → **chat-server**，然后在这个文件夹里打开终端，执行 **npm install** 和 **npm run dev**。

这样就是「chat-server 目录」下的完整操作。

---

## 常见报错

### 1. `EPERM: operation not permitted, rename ... query_engine-windows.dll.node`

Windows 下 Prisma 的 DLL 被占用。**处理方式**：

- 若脚本最后仍能继续启动（有 `SERVER_OK port=4000`），可忽略。
- 若直接报错退出：先**关掉 Cursor/VS Code**，新开一个 PowerShell，再在 `services\chat-server` 下执行 `npm run dev`；或临时关闭杀毒对该目录的实时扫描后再试。

### 2. `EADDRINUSE: address already in use :::4000`

说明 4000 端口已被占用（例如之前已开过一个 chat-server 没关）。**处理方式**：

在 **`services\chat-server`** 目录下执行（先释放 4000 端口）：

```powershell
powershell -ExecutionPolicy Bypass -File .\scripts\kill-port-4000.ps1
```

然后再执行 `npm run dev`。
