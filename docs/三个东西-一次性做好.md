# 三个东西：.env、chat-server 进程、Nginx 反代 —— 一次性做好

这三样是 **Live Chat 能用的前提**。我无法在你电脑或服务器上替你执行命令，但已经把「你要做的」缩成**各执行一条命令**（或复制一份配置）。按下面做一遍即可。

---

## 一、`.env`（环境变量）

**是什么**：主站和 chat-server 各有一个 `.env` 文件，里面要写 `CHAT_SERVER_INTERNAL_URL`、`CHAT_ADMIN_JWT_SECRET` 等；且**两边的 JWT 必须完全一致**。

**我帮你做好的**：已经写好脚本，会**自动生成同一个 JWT** 并写入主站和 chat-server 的 `.env`，并补全 Live Chat 相关项。

**你要做的**（在**本机**项目根目录执行一次）：

```bash
node scripts/setup-live-chat-env.cjs
```

- 若主站没有 `.env`，会从 `.env.example` 复制再写入 Live Chat 相关项。
- 若 chat-server 没有 `.env`，会从 `.env.example` 复制再写入。
- 会生成一个随机 `CHAT_ADMIN_JWT_SECRET`，并**同时写入主站和 chat-server**，保证一致。
- 主站会写入 `CHAT_SERVER_INTERNAL_URL="http://127.0.0.1:4000"`。
- chat-server 会写入 `CHAT_ALLOWED_ORIGINS`、`ADMIN_ALLOWED_ORIGINS`（admin1167.com / admin1167.net）。

执行完后，可再运行 `.\scripts\check-live-chat-env.ps1` 检查是否都齐了。

**服务器上的 .env**：若你服务器是 git pull 部署，把本机改好的 `.env` 和 `services/chat-server/.env` **按你现有方式**拷到服务器（或服务器上再执行一次 `node scripts/setup-live-chat-env.cjs`，注意先 cd 到项目根目录）。不要将 .env 提交到 git。

---

## 二、chat-server 进程（聊天服务一直开着）

**是什么**：Live Chat 的后端是一个单独的程序（chat-server），要**一直运行**在 4000 端口，前台和后台才能连上。

**我帮你做好的**：已经写好**一键启动脚本**，会进 `services/chat-server`、安装依赖、生成 Prisma、再启动。

**你要做的**：

- **本机（Windows）**：在项目根目录执行一次：
  ```powershell
  powershell -ExecutionPolicy Bypass -File .\scripts\start-chat-server.ps1
  ```
  会打开一个窗口跑 chat-server，看到 `SERVER_OK port=4000`、`WS_OK` 就表示成功；关掉窗口就停。

- **服务器（Linux）**：SSH 登录后，进入网站项目根目录，执行一次：
  ```bash
  bash scripts/start-chat-server.sh
  ```
  会用 PM2 启动 chat-server，并 `pm2 save`。之后每次重启服务器，PM2 一般会自动把 chat-server 拉起来。

---

## 三、Nginx 反代（把 /chat/、/ws-visitor、/ws-admin 转到 4000）

**是什么**：浏览器访问的是 https://admin1167.com/ws-visitor 等，Nginx 要把这些请求**转给本机 4000 端口的 chat-server**，否则前台/后台连不上。

**我帮你做好的**：项目里已经有一份**完整可用的 Nginx 配置**：`docs/admin1167.conf-改好`（里面已包含 `/chat/`、`/ws-visitor/`、`/ws-admin/` 反代到 4000）。

**你要做的**（在**服务器**上）：

1. 用你习惯的方式打开服务器上的 Nginx 配置（例如）：
   ```bash
   sudo nano /etc/nginx/sites-available/admin1167.conf
   ```
2. 把本机项目里 **`docs/admin1167.conf-改好`** 的**全部内容**复制过去，**整体替换**掉原来 `admin1167.conf` 里的内容，保存。
3. 检查配置并重载 Nginx（**只输入下面两行命令，不要多打字**）：
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

若你服务器上已有 `admin1167.conf` 且只是缺 Live Chat 的几段，可以只把 `docs/admin1167.conf-改好` 里和 Live Chat 相关的 `location /chat/`、`location /ws-visitor/`、`location /ws-admin/` 三块复制到对应 server 块里。

---

## 小结（你要做的三条）

| 项目 | 在哪里做 | 命令或操作 |
|------|----------|------------|
| **1. .env** | 本机项目根目录 | `node scripts/setup-live-chat-env.cjs`（服务器上若单独部署，同样在项目根执行一次或把本机 .env 拷过去） |
| **2. chat-server 进程** | 本机：PowerShell<br>服务器：SSH 后项目根目录 | 本机：`powershell -ExecutionPolicy Bypass -File .\scripts\start-chat-server.ps1`<br>服务器：`bash scripts/start-chat-server.sh` |
| **3. Nginx 反代** | 服务器 | 用 `docs/admin1167.conf-改好` 内容替换或合并到 `/etc/nginx/sites-available/admin1167.conf`，然后 `sudo nginx -t`，再 `sudo systemctl reload nginx` |

做完这三步，再部署/重启主站，Live Chat 就可以按「怎么判断 Live Chat 是否正常」那几条验收。
