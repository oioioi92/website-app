# 一次性部署：让前台和后台变成「新版本」

**为什么前台和后台还是旧数据？**  
因为 **admin1167.com / admin1167.net 是在服务器上跑的**，服务器上跑的代码还是旧的。你在本机改的代码，必须**部署到服务器**（拉代码 + 构建 + 重启）后，网站才会变成新版本。

下面按顺序做一遍，前台和后台就会更新，Live Chat 等新功能才会生效。

---

## 第一步：本机 —— 把代码推到 Git

在你**本机**（Website-new 项目根目录）打开 PowerShell 或 CMD，执行：

```bash
git add .
git status
git commit -m "deploy: Live Chat 修复与注册登录、部署脚本"
git push origin main
```

（如果已经 push 过，可跳过；确保服务器能拉到的就是最新代码。）

---

## 第二步：服务器 —— 用哪种方式更新？

服务器上项目有两种常见情况，选一种做即可。

### 方式 A：服务器上项目是用 git clone 的（推荐）

1. **SSH 登录服务器**  
   例如：`ssh root@68.183.227.172`

2. **进入网站项目目录**  
   例如：`cd /root/website` 或 `cd /var/www/website-app`（按你实际路径）

3. **一键拉代码 + 构建 + 重启**（在项目根目录执行）：
   ```bash
   bash scripts/server-pull-and-deploy.sh
   ```
   脚本会：拉最新代码 → 主站 `npm ci`、`npm run build`、`pm2 restart` → 若有 `services/chat-server` 则安装并重启 chat-server。

4. **若没有用脚本**，可自己执行：
   ```bash
   git fetch origin
   git checkout main
   git pull origin main
   npm ci
   npm run build
   pm2 restart website-phase2
   ```
   然后若有 chat-server：
   ```bash
   cd services/chat-server
   npm ci
   npm run prisma:generate
   pm2 restart chat-server
   cd ../..
   ```

### 方式 B：服务器上不用 git，是用本机上传的

1. **本机**在项目根目录执行上传脚本（会传源码，包含 `middleware.ts`、`proxy.ts`、`services/`）：
   ```powershell
   .\scripts\deploy-to-server.ps1
   ```

2. **SSH 到服务器**后，进入网站目录，执行：
   ```bash
   cd /root/website
   npm install
   npm run build
   pm2 restart website-phase2
   ```

3. **chat-server 也要更新并重启**（在服务器上）：
   ```bash
   cd /root/website/services/chat-server
   npm install
   npm run prisma:generate
   pm2 restart chat-server
   ```

---

## 第三步：确认服务器 .env 和 chat-server

- **主站根目录 .env** 里要有：
  - `CHAT_SERVER_INTERNAL_URL="http://127.0.0.1:4000"`
  - `CHAT_ADMIN_JWT_SECRET` 与 chat-server 的 `.env` **完全一致**
- **chat-server** 要一直在跑：`pm2 list` 里能看到 `chat-server` 且状态为 online。
- **Nginx** 已按 `docs/admin1167.conf-改好` 配好 `/chat/`、`/ws-visitor/`、`/ws-admin/` 并已 `systemctl reload nginx`。

（本机可先跑 `scripts/check-live-chat-env.ps1` 检查 .env；服务器上的 .env 需你 SSH 上去自己核对或改。）

---

## 第四步：验证（前台和后台是否已是「新版本」）

- **前台**：无痕打开 https://admin1167.com → 点右下角 Live 气泡 → 应显示 **Online** 或「客服已连接」，能发消息。
- **后台**：打开 https://admin1167.net/admin/chat → **没有**黄色「Live Chat 服务未连接」，能看到会话并回复。

若仍不对，按 [LIVE-CHAT-上线检查.md](./LIVE-CHAT-上线检查.md) 逐项检查 .env、chat-server、Nginx。

---

## 小结

| 你在哪里做 | 做什么 |
|------------|--------|
| **本机** | `git push origin main`（或先 `git add` / `commit`） |
| **服务器** | 进入项目目录 → 拉代码（`git pull` 或先跑 `deploy-to-server.ps1` 再 SSH）→ `npm ci`、`npm run build`、`pm2 restart` 主站 → 若有 chat-server 则进 `services/chat-server` 安装并 `pm2 restart chat-server` |
| **服务器** | 确认 .env 有 `CHAT_SERVER_INTERNAL_URL` 和 `CHAT_ADMIN_JWT_SECRET`，Nginx 已反代 Live Chat |

做完这些，前台和后台就会是**新代码**，Live Chat 判断方式按上面「第四步」验收即可。
